{"version":3,"file":"26.8d4434baead2377ea20a.bundle.js","sources":["webpack:///../superset-ui-legacy-plugin-chart-rose/lib/Rose.js"],"sourcesContent":["\"use strict\";exports.__esModule=!0,exports.default=void 0;var _d=_interopRequireDefault(require(\"d3\")),_propTypes=_interopRequireDefault(require(\"prop-types\")),_nvd=_interopRequireDefault(require(\"nvd3\")),_color=require(\"@superset-ui/color\"),_numberFormat=require(\"@superset-ui/number-format\"),_timeFormat=require(\"@superset-ui/time-format\");require(\"./Rose.css\");function _interopRequireDefault(a){return a&&a.__esModule?a:{default:a}}/**\n * Licensed to the Apache Software Foundation (ASF) under one\n * or more contributor license agreements.  See the NOTICE file\n * distributed with this work for additional information\n * regarding copyright ownership.  The ASF licenses this file\n * to you under the Apache License, Version 2.0 (the\n * \"License\"); you may not use this file except in compliance\n * with the License.  You may obtain a copy of the License at\n *\n *   http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing,\n * software distributed under the License is distributed on an\n * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n * KIND, either express or implied.  See the License for the\n * specific language governing permissions and limitations\n * under the License.\n */ /* eslint no-use-before-define: [\"error\", { \"functions\": false }] */ /* eslint-disable sort-keys, no-magic-numbers, no-restricted-syntax, no-plusplus, babel/no-invalid-this */var propTypes={// Data is an object hashed by numeric value, perhaps timestamp\ndata:_propTypes.default.objectOf(_propTypes.default.arrayOf(_propTypes.default.shape({key:_propTypes.default.arrayOf(_propTypes.default.string),name:_propTypes.default.arrayOf(_propTypes.default.string),time:_propTypes.default.number,value:_propTypes.default.number}))),width:_propTypes.default.number,height:_propTypes.default.number,dateTimeFormat:_propTypes.default.string,numberFormat:_propTypes.default.string,useRichTooltip:_propTypes.default.bool,useAreaProportions:_propTypes.default.bool};function copyArc(a){return{startAngle:a.startAngle,endAngle:a.endAngle,innerRadius:a.innerRadius,outerRadius:a.outerRadius}}function sortValues(c,a){return c.value===a.value?c.name>a.name?1:-1:a.value-c.value}function Rose(a,b){var p=Math.floor;function c(a){return a[A[0]].map(function(a,b){return{disabled:J.disabled[b],key:a.name}})}function d(a,b,c){var d=p(a.arcId/C),e=w?c[A[d]].filter(function(a){return!J.disabled[a.id%C]}).map(function(b){return{key:b.name,value:b.value,color:F(b.name),highlight:b.id===a.arcId}}):[{key:a.name,value:a.val,color:F(a.name)}];return{key:\"Date\",value:a.time,series:e}}// Compute inner and outer angles for each data point\nfunction e(a){// Find the max sum of values across all time\nfor(var b=Math.PI,c=0,d=0,e=[],f=A,g=Array.isArray(f),h=0,f=g?f:f[Symbol.iterator]();;){var j;if(g){if(h>=f.length)break;j=f[h++]}else{if(h=f.next(),h.done)break;j=h.value}var k=j,l=z[k].reduce(function(b,a,c){return b+(J.disabled[c]?0:a.value)},0);c=l>c?l:c,e[d]=l,d++}// Compute angle occupied by each time grain\nfor(var m=[],n=0;n<=B;n++)m.push(2*b/B*n-b/2);// Compute proportion\nfor(var o=O/c,p=function(a,b){var c=Math.sqrt;return x?c(o*O*a+b*b):o*a+b},q={data:[],extend:{},push:{},pieStart:{},pie:{},pieOver:{},mini:{},labels:[],groupLabels:[]},r=0,s=0;s<B;s++){for(var u=A[s],t=m[s],w=m[s+1],y=2*b/e[s],D=0,E=void 0,F=0,G=void 0,H=a[u],I=Array.isArray(H),K=0,H=I?H:H[Symbol.iterator]();;){var L;if(I){if(K>=H.length)break;L=H[K++]}else{if(K=H.next(),K.done)break;L=K.value}var M=L,v=J.disabled[r%C]?0:M.value,N=M.name,P=M.time;M.id=r,E=p(v,D),q.data.push({startAngle:t,endAngle:w,innerRadius:D,outerRadius:E,name:N,arcId:r,val:v,time:P}),q.extend[r]={startAngle:t,endAngle:w,innerRadius:D,name:N,outerRadius:E+Q},q.push[r]={startAngle:t,endAngle:w,innerRadius:D+Q,outerRadius:E+Q},q.pieStart[r]={startAngle:t,endAngle:w,innerRadius:R*O,outerRadius:O},q.mini[r]={startAngle:t,endAngle:w,innerRadius:D*R,outerRadius:E*R},r++,D=E}var Y=Object.assign({},q.data[s*C]);Y.outerRadius=O+20,Y.innerRadius=O+15,q.labels.push(Y);for(var S=a[u].concat().sort(sortValues),T=Array.isArray(S),U=0,S=T?S:S[Symbol.iterator]();;){var V;if(T){if(U>=S.length)break;V=S[U++]}else{if(U=S.next(),U.done)break;V=U.value}var W=V,X=J.disabled[W.id%C]?0:W.value;G=y*X+F,q.pie[W.id]={startAngle:F,endAngle:G,innerRadius:O*R,outerRadius:O,percent:W.value/e[s]},q.pieOver[W.id]={startAngle:F,endAngle:G,innerRadius:O*R,outerRadius:O+Q},F=G}}return q.groupLabels=q.data.slice(0,C),q}function f(a,b){return function(c){var d=_d.default.interpolate(copyArc(c),copyArc(a));return function(a){return b(Object.assign(c,d(a)))}}}function h(a){return f(a,function(a){return G(a)})}function i(a){return f(a,function(a){return\"translate(\"+G.centroid(a)+\")\"})}// Grab the ID range of segments stand between\n// this segment and the edge of the circle\nfunction j(a){if(X[a])return X[a];var b=p(a/C);return X[a]=[a+1,C*(b+1)-1],X[a]}// Get the IDs of all segments in a timeIndex\nfunction k(a){if(Y[a])return Y[a];var b=p(a/C);return Y[a]=[b*C,(b+1)*C-1],Y[a]}function l(a,b){I.data(d(a,b,z)).hidden(!1);var c=_d.default.select(this);if(c.classed(\"hover\",!0),0>Z&&!$){c.select(\"path\").interrupt().transition().duration(180).attrTween(\"d\",h(W.extend[b]));var e=j(b);ca.filter(function(a){return e[0]<=a.arcId&&a.arcId<=e[1]}).interrupt().transition().duration(180).attrTween(\"d\",function(a){return h(W.push[a.arcId])(a)})}else if(!$){var f=k(Z);f[0]<=a.arcId&&a.arcId<=f[1]&&c.select(\"path\").interrupt().transition().duration(180).attrTween(\"d\",h(W.pieOver[b]))}}function m(a,b){I.hidden(!0);var c=_d.default.select(this);if(c.classed(\"hover\",!1),0>Z&&!$){c.select(\"path\").interrupt().transition().duration(180).attrTween(\"d\",h(W.data[b]));var e=j(b);ca.filter(function(a){return e[0]<=a.arcId&&a.arcId<=e[1]}).interrupt().transition().duration(180).attrTween(\"d\",function(a){return h(W.data[a.arcId])(a)})}else if(!$){var f=k(Z);f[0]<=a.arcId&&a.arcId<=f[1]&&c.select(\"path\").interrupt().transition().duration(180).attrTween(\"d\",h(W.pie[b]))}}function n(a,b){if(!$){var c=_d.default.event.altKey?3750:375,e=k(b);if(0>Z)$=!0,Z=b,aa.interrupt().transition().duration(c).attrTween(\"transform\",function(a){return i({outerRadius:0,innerRadius:0,startAngle:a.startAngle,endAngle:a.endAngle})(a)}).style(\"opacity\",0),ba.attr(\"transform\",\"translate(\"+G.centroid({outerRadius:O+20,innerRadius:O+15,startAngle:W.data[b].startAngle,endAngle:W.data[b].endAngle})+\")\").interrupt().transition().delay(c).duration(c).attrTween(\"transform\",function(a){return i({outerRadius:O+20,innerRadius:O+15,startAngle:W.pie[e[0]+a.arcId].startAngle,endAngle:W.pie[e[0]+a.arcId].endAngle})(a)}).style(\"opacity\",function(a){return J.disabled[a.arcId]||W.pie[e[0]+a.arcId].percent<P?0:1}),_.classed(\"clickable\",function(a){return e[0]>a.arcId||a.arcId>e[1]}),ca.filter(function(a){return e[0]<=a.arcId&&a.arcId<=e[1]}).interrupt().transition().duration(c).attrTween(\"d\",function(a){return h(W.pieStart[a.arcId])(a)}).transition().duration(c).attrTween(\"d\",function(a){return h(W.pie[a.arcId])(a)}).each(\"end\",function(){$=!1}),ca.filter(function(a){return e[0]>a.arcId||a.arcId>e[1]}).interrupt().transition().duration(c).attrTween(\"d\",function(a){return h(W.mini[a.arcId])(a)});else if(Z<e[0]||e[1]<Z){$=!0;var f=k(Z);aa.interrupt().transition().delay(c).duration(c).attrTween(\"transform\",function(a){return i(W.labels[a.arcId/C])(a)}).style(\"opacity\",1),ba.interrupt().transition().duration(c).attrTween(\"transform\",i({outerRadius:O+20,innerRadius:O+15,startAngle:W.data[Z].startAngle,endAngle:W.data[Z].endAngle})).style(\"opacity\",0),_.classed(\"clickable\",!0),ca.filter(function(a){return f[0]<=a.arcId&&a.arcId<=f[1]}).interrupt().transition().duration(c).attrTween(\"d\",function(a){return h(W.pieStart[a.arcId])(a)}).transition().duration(c).attrTween(\"d\",function(a){return h(W.data[a.arcId])(a)}).each(\"end\",function(){Z=-1,$=!1}),ca.filter(function(a){return f[0]>a.arcId||a.arcId>f[1]}).interrupt().transition().delay(c).duration(c).attrTween(\"d\",function(a){return h(W.data[a.arcId])(a)})}}}function o(){var a=_d.default.event.altKey?3e3:300;g.datum(c(z)).call(H);var b=e(z);if($=!0,0>Z)ca.style(\"opacity\",1).interrupt().transition().duration(a).attrTween(\"d\",function(a){return h(b.data[a.arcId])(a)}).each(\"end\",function(){$=!1,W=b}).transition().duration(0).style(\"opacity\",function(a){return J.disabled[a.arcId%C]?0:1});else{var f=k(Z);ca.style(\"opacity\",1).interrupt().transition().duration(a).attrTween(\"d\",function(a){return f[0]<=a.arcId&&a.arcId<=f[1]?h(b.pie[a.arcId])(a):h(b.mini[a.arcId])(a)}).each(\"end\",function(){$=!1,W=b}).transition().duration(0).style(\"opacity\",function(a){return J.disabled[a.arcId%C]?0:1}),ba.interrupt().transition().duration(a).attrTween(\"transform\",function(a){return i({outerRadius:O+20,innerRadius:O+15,startAngle:b.pie[f[0]+a.arcId].startAngle,endAngle:b.pie[f[0]+a.arcId].endAngle})(a)}).style(\"opacity\",function(a){return J.disabled[a.arcId]||W.pie[f[0]+a.arcId].percent<P?0:1})}}var q=b.data,r=b.width,s=b.height,t=b.colorScheme,u=b.dateTimeFormat,v=b.numberFormat,w=b.useRichTooltip,x=b.useAreaProportions,y=_d.default.select(a);y.classed(\"superset-legacy-chart-rose\",!0);var z=q,A=Object.keys(z).map(function(a){return parseInt(a,10)}).sort(function(c,a){return c-a}),B=A.length,C=z[A[0]].length,D=(0,_numberFormat.getNumberFormatter)(v),E=(0,_timeFormat.getTimeFormatter)(u),F=_color.CategoricalColorNamespace.getScale(t);_d.default.select(\".nvtooltip\").remove(),y.selectAll(\"*\").remove();var G=_d.default.svg.arc(),H=_nvd.default.models.legend(),I=_nvd.default.models.tooltip(),J={disabled:z[A[0]].map(function(){return!1})},K=y.append(\"svg\").attr(\"width\",r).attr(\"height\",s),L=K.append(\"g\").attr(\"class\",\"rose\").append(\"g\"),g=L.append(\"g\").attr(\"class\",\"legendWrap\");H.width(r).color(function(a){return F(a.key)}),g.datum(c(z)).call(H),I.headerFormatter(E).valueFormatter(D);// Compute max radius, which the largest value will occupy\nvar M=s-H.height(),N={top:H.height()},O=Math.min(r,M)/2-35,P=.05,Q=8,R=.075,S=\"translate(\"+r/2+\",\"+(M/2+N.top)+\")\",T=L.append(\"g\").attr(\"transform\",S).attr(\"class\",\"roseWrap\"),U=L.append(\"g\").attr(\"transform\",S).attr(\"class\",\"labelsWrap\"),V=L.append(\"g\").attr(\"transform\",S).attr(\"class\",\"groupLabelsWrap\"),W=e(z),X={},Y={},Z=-1,$=!1,_=T.selectAll(\"g\").data(JSON.parse(JSON.stringify(W.data)))// deep copy data state\n.enter().append(\"g\").attr(\"class\",\"segment\").classed(\"clickable\",!0).on(\"mouseover\",l).on(\"mouseout\",m).on(\"mousemove\",function(){I()}).on(\"click\",n),aa=U.selectAll(\"g\").data(JSON.parse(JSON.stringify(W.labels))).enter().append(\"g\").attr(\"class\",\"roseLabel\").attr(\"transform\",function(a){return\"translate(\"+G.centroid(a)+\")\"});aa.append(\"text\").style(\"text-anchor\",\"middle\").style(\"fill\",\"#000\").text(function(a){return E(a.time)});var ba=V.selectAll(\"g\").data(JSON.parse(JSON.stringify(W.groupLabels))).enter().append(\"g\");ba.style(\"opacity\",0).attr(\"class\",\"roseGroupLabels\").append(\"text\").style(\"text-anchor\",\"middle\").style(\"fill\",\"#000\").text(function(a){return a.name});var ca=_.append(\"path\").attr(\"class\",\"arc\").attr(\"fill\",function(a){return F(a.name)}).attr(\"d\",G);H.dispatch.on(\"stateChange\",function(a){J.disabled!==a.disabled&&(J.disabled=a.disabled,o())})}Rose.displayName=\"Rose\",Rose.propTypes=propTypes;var _default=Rose;exports.default=_default;"],"mappings":"AAAA","sourceRoot":""}